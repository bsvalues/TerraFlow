{% extends "base.html" %}

{% block title %}{% if edit_mode %}Edit Template{% else %}Create Template{% endif %}{% endblock %}

{% block head %}
<style>
    .section-card {
        margin-bottom: 15px;
        border-left: 3px solid #3498db;
    }
    .section-handle {
        cursor: move;
        color: #95a5a6;
    }
    .section-handle:hover {
        color: #3498db;
    }
    .section-tools {
        display: flex;
        gap: 10px;
    }
    .section-tools button {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 0.9rem;
    }
    .section-edit {
        color: #3498db;
    }
    .section-delete {
        color: #e74c3c;
    }
    .section-type-badge {
        font-size: 0.75rem;
    }
    .content-field {
        padding: 8px 12px;
        background-color: #f8f9fa;
        border-radius: 4px;
        margin-top: 10px;
        font-family: monospace;
        max-height: 100px;
        overflow-y: auto;
        font-size: 0.8rem;
    }
    .form-actions {
        margin-top: 30px;
        padding-top: 15px;
        border-top: 1px solid #eee;
    }
    .section-list {
        min-height: 200px;
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
    }
    .section-panel {
        background-color: #fff;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .section-type-icon {
        width: 24px;
        text-align: center;
        margin-right: 8px;
    }
    .section-title-display {
        font-weight: bold;
        margin-bottom: 5px;
    }
    .template-info-card {
        background-color: #f1f9ff;
        border-left: 5px solid #3498db;
    }
    .content-preview {
        max-height: 150px;
        overflow-y: auto;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>{% if edit_mode %}Edit Template{% else %}Create Template{% endif %}</h1>
        <div>
            <a href="{{ url_for('reports.reports_dashboard') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Back to Dashboard
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-4">
            <div class="card mb-4 template-info-card">
                <div class="card-body">
                    <h5 class="card-title">Template Information</h5>
                    <form id="template-form" method="post">
                        <div class="mb-3">
                            <label for="template-name" class="form-label">Template Name</label>
                            <input type="text" class="form-control" id="template-name" name="name" 
                                   value="{{ template.name if template else '' }}" required>
                        </div>
                        <div class="mb-3">
                            <label for="template-description" class="form-label">Description</label>
                            <textarea class="form-control" id="template-description" name="description" rows="3">{{ template.description if template else '' }}</textarea>
                        </div>
                        <div class="mb-3">
                            <label for="template-type" class="form-label">Template Type</label>
                            <select class="form-control" id="template-type" name="template_type" required>
                                <option value="property_assessment" {% if template and template.template_type == 'property_assessment' %}selected{% endif %}>Property Assessment</option>
                                <option value="geospatial_analysis" {% if template and template.template_type == 'geospatial_analysis' %}selected{% endif %}>Geospatial Analysis</option>
                                <option value="anomaly_report" {% if template and template.template_type == 'anomaly_report' %}selected{% endif %}>Anomaly Report</option>
                                <option value="custom" {% if template and template.template_type == 'custom' %}selected{% endif %}>Custom</option>
                            </select>
                        </div>
                        
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> {% if edit_mode %}Update Template{% else %}Create Template{% endif %}
                            </button>
                            {% if edit_mode %}
                            <a href="{{ url_for('reports.view_template', template_id=template.template_id) }}" class="btn btn-outline-secondary">
                                <i class="fas fa-times"></i> Cancel
                            </a>
                            {% endif %}
                        </div>
                    </form>
                </div>
            </div>

            {% if edit_mode %}
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Add Section</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="section-type" class="form-label">Section Type</label>
                        <select class="form-control" id="section-type">
                            <option value="header">Header</option>
                            <option value="text">Text</option>
                            <option value="property_info">Property Information</option>
                            <option value="valuation">Valuation Summary</option>
                            <option value="map">Map</option>
                            <option value="table">Table</option>
                            <option value="chart">Chart</option>
                            <option value="comparable_properties">Comparable Properties</option>
                            <option value="footer">Footer</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="section-title" class="form-label">Section Title</label>
                        <input type="text" class="form-control" id="section-title">
                    </div>
                    <button id="add-section-btn" class="btn btn-success w-100">
                        <i class="fas fa-plus"></i> Add Section
                    </button>
                </div>
            </div>
            {% endif %}
        </div>

        <div class="col-lg-8">
            {% if edit_mode %}
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Template Sections</h5>
                </div>
                <div class="card-body">
                    <div id="sections-container" class="section-list">
                        {% if template and template.sections %}
                            {% for section in template.sections %}
                            <div class="section-card p-3 mb-2 section-panel" data-section-id="{{ section.section_id }}">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="d-flex align-items-center">
                                        <div class="section-handle me-2"><i class="fas fa-grip-vertical"></i></div>
                                        <div>
                                            <div class="section-title-display">{{ section.title }}</div>
                                            <span class="badge bg-info section-type-badge">{{ section.section_type }}</span>
                                        </div>
                                    </div>
                                    <div class="section-tools">
                                        <button class="section-edit" title="Edit Section">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="section-delete" title="Delete Section">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="content-preview mt-2">
                                    <div class="content-field">{{ section.content | tojson }}</div>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-center text-muted py-5">
                                <i class="fas fa-file-alt fa-3x mb-3"></i>
                                <p>No sections yet. Add sections to your template using the panel on the left.</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% else %}
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Template Preview</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> Create the template first, then you can add and customize sections.
                    </div>
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-file-alt fa-3x mb-3"></i>
                        <p>Your template sections will appear here after creation.</p>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Section Edit Modal -->
<div class="modal fade" id="sectionEditModal" tabindex="-1" aria-labelledby="sectionEditModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="sectionEditModalLabel">Edit Section</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="edit-section-title" class="form-label">Section Title</label>
                    <input type="text" class="form-control" id="edit-section-title">
                </div>
                <div class="mb-3">
                    <label for="edit-section-content" class="form-label">Section Content (JSON)</label>
                    <textarea class="form-control font-monospace" id="edit-section-content" rows="10"></textarea>
                    <div class="form-text">Edit the JSON content of this section. Be careful to maintain valid JSON format.</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-section-btn">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Section Deletion Confirmation Modal -->
<div class="modal fade" id="deleteSectionModal" tabindex="-1" aria-labelledby="deleteSectionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteSectionModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this section? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm-delete-btn">Delete Section</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        {% if edit_mode %}
        let currentSectionId = null;
        
        // Section content templates
        const sectionTemplates = {
            header: {
                include_logo: true,
                include_date: true,
                include_page_numbers: true,
                subtitle: "Report Subtitle"
            },
            text: {
                text: "Enter your text content here.",
                format: "paragraph"
            },
            property_info: {
                fields: ["property_id", "address", "owner_name", "parcel_id", "property_type", "year_built", "square_footage", "lot_size"],
                include_photo: true,
                layout: "table"
            },
            valuation: {
                fields: ["assessed_value", "land_value", "improvement_value", "market_value", "previous_value", "value_change_percent"],
                include_chart: true,
                chart_type: "bar",
                chart_title: "Value Components"
            },
            map: {
                map_type: "property_location",
                include_nearby_sales: true,
                show_parcel_boundaries: true,
                zoom_level: 16
            },
            table: {
                columns: ["property_id", "address", "assessed_value", "property_type", "year_built"],
                data_key: "properties",
                sort_by: "assessed_value",
                sort_direction: "desc"
            },
            chart: {
                chart_type: "bar",
                data_field: "assessed_value",
                group_by: "property_type",
                aggregate: "avg",
                sort_by: "value",
                sort_direction: "desc"
            },
            comparable_properties: {
                num_properties: 5,
                fields: ["address", "sale_date", "sale_price", "square_footage", "price_per_sqft", "year_built", "distance"],
                sort_by: "sale_date",
                sort_direction: "desc"
            },
            footer: {
                include_disclaimer: true,
                include_contact: true,
                include_generated_date: true
            }
        };
        
        // Add section button click handler
        document.getElementById('add-section-btn').addEventListener('click', function() {
            const sectionType = document.getElementById('section-type').value;
            const sectionTitle = document.getElementById('section-title').value;
            
            if (!sectionTitle) {
                alert('Please enter a section title');
                return;
            }
            
            // Create content based on section type
            const sectionContent = sectionTemplates[sectionType] || {};
            
            // Add section to the template
            addSection(sectionType, sectionTitle, sectionContent);
            
            // Clear the form
            document.getElementById('section-title').value = '';
        });
        
        // Function to add a section to the UI
        function addSection(sectionType, sectionTitle, sectionContent) {
            // Generate a temporary section ID
            const sectionId = 'temp_' + Date.now();
            
            // Create section HTML
            const sectionHtml = `
                <div class="section-card p-3 mb-2 section-panel" data-section-id="${sectionId}">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="d-flex align-items-center">
                            <div class="section-handle me-2"><i class="fas fa-grip-vertical"></i></div>
                            <div>
                                <div class="section-title-display">${sectionTitle}</div>
                                <span class="badge bg-info section-type-badge">${sectionType}</span>
                            </div>
                        </div>
                        <div class="section-tools">
                            <button class="section-edit" title="Edit Section">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="section-delete" title="Delete Section">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="content-preview mt-2">
                        <div class="content-field">${JSON.stringify(sectionContent, null, 2)}</div>
                    </div>
                </div>
            `;
            
            // Add section to the container
            const sectionsContainer = document.getElementById('sections-container');
            
            // Remove placeholder if it exists
            const placeholder = sectionsContainer.querySelector('.text-center.text-muted.py-5');
            if (placeholder) {
                placeholder.remove();
            }
            
            // Add the new section
            sectionsContainer.insertAdjacentHTML('beforeend', sectionHtml);
            
            // Add event listeners to the new section
            initSectionEventListeners(sectionId);
            
            // Make an API call to add the section to the template
            const templateId = window.location.pathname.split('/')[3]; // Assuming path is /reports/templates/{templateId}/edit
            
            fetch(`/reports/templates/${templateId}/sections`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    section_type: sectionType,
                    title: sectionTitle,
                    content: sectionContent
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update the section ID with the one from the server
                    const section = document.querySelector(`.section-card[data-section-id="${sectionId}"]`);
                    if (section) {
                        // Find the new section in the updated template
                        const newSection = data.template.sections.find(s => s.title === sectionTitle && s.section_type === sectionType);
                        if (newSection) {
                            section.setAttribute('data-section-id', newSection.section_id);
                        }
                    }
                } else {
                    alert('Failed to add section: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while adding the section');
            });
        }
        
        // Initialize event listeners for existing sections
        function initializeSections() {
            const sections = document.querySelectorAll('.section-card');
            sections.forEach(section => {
                const sectionId = section.getAttribute('data-section-id');
                initSectionEventListeners(sectionId);
            });
        }
        
        // Add event listeners to a section
        function initSectionEventListeners(sectionId) {
            const section = document.querySelector(`.section-card[data-section-id="${sectionId}"]`);
            if (!section) return;
            
            // Edit button
            const editButton = section.querySelector('.section-edit');
            editButton.addEventListener('click', function() {
                editSection(sectionId);
            });
            
            // Delete button
            const deleteButton = section.querySelector('.section-delete');
            deleteButton.addEventListener('click', function() {
                confirmDeleteSection(sectionId);
            });
        }
        
        // Edit section
        function editSection(sectionId) {
            currentSectionId = sectionId;
            const section = document.querySelector(`.section-card[data-section-id="${sectionId}"]`);
            
            // Get section data
            const titleElement = section.querySelector('.section-title-display');
            const contentElement = section.querySelector('.content-field');
            
            // Update modal fields
            document.getElementById('edit-section-title').value = titleElement.textContent;
            document.getElementById('edit-section-content').value = contentElement.textContent;
            
            // Show the modal
            const modal = new bootstrap.Modal(document.getElementById('sectionEditModal'));
            modal.show();
        }
        
        // Save section changes
        document.getElementById('save-section-btn').addEventListener('click', function() {
            if (!currentSectionId) return;
            
            const section = document.querySelector(`.section-card[data-section-id="${currentSectionId}"]`);
            const templateId = window.location.pathname.split('/')[3];
            
            // Get updated values
            const newTitle = document.getElementById('edit-section-title').value;
            let newContent = {};
            
            try {
                newContent = JSON.parse(document.getElementById('edit-section-content').value);
            } catch (e) {
                alert('Invalid JSON content. Please check your format.');
                return;
            }
            
            // Update the UI
            section.querySelector('.section-title-display').textContent = newTitle;
            section.querySelector('.content-field').textContent = JSON.stringify(newContent, null, 2);
            
            // Update the section on the server
            fetch(`/reports/templates/${templateId}/sections/${currentSectionId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    title: newTitle,
                    content: newContent
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    alert('Failed to update section: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while updating the section');
            });
            
            // Close the modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('sectionEditModal'));
            modal.hide();
        });
        
        // Confirm section deletion
        function confirmDeleteSection(sectionId) {
            currentSectionId = sectionId;
            
            // Show the confirmation modal
            const modal = new bootstrap.Modal(document.getElementById('deleteSectionModal'));
            modal.show();
        }
        
        // Delete section
        document.getElementById('confirm-delete-btn').addEventListener('click', function() {
            if (!currentSectionId) return;
            
            const section = document.querySelector(`.section-card[data-section-id="${currentSectionId}"]`);
            const templateId = window.location.pathname.split('/')[3];
            
            // Remove the section from the UI
            section.remove();
            
            // Check if there are no more sections
            const sections = document.querySelectorAll('.section-card');
            if (sections.length === 0) {
                // Add placeholder
                const sectionsContainer = document.getElementById('sections-container');
                sectionsContainer.innerHTML = `
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-file-alt fa-3x mb-3"></i>
                        <p>No sections yet. Add sections to your template using the panel on the left.</p>
                    </div>
                `;
            }
            
            // Delete the section on the server
            fetch(`/reports/templates/${templateId}/sections/${currentSectionId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    alert('Failed to delete section: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while deleting the section');
            });
            
            // Close the modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('deleteSectionModal'));
            modal.hide();
        });
        
        // Initialize sections
        initializeSections();
        {% endif %}
    });
</script>
{% endblock %}