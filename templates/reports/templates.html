{% extends "base.html" %}

{% block title %}Report Templates{% endblock %}

{% block head %}
<style>
    .template-card {
        margin-bottom: 20px;
        transition: transform 0.3s;
        height: 100%;
        border: none;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .template-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    .card-header {
        background-color: #f8f9fa;
        border-bottom: none;
        padding: 15px 20px;
    }
    .card-footer {
        background-color: white;
        border-top: 1px solid #f1f1f1;
        padding: 15px 20px;
    }
    .template-type {
        display: inline-block;
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 0.8rem;
        margin-bottom: 10px;
    }
    .type-property {
        background-color: #e3f7ea;
        color: #1d8348;
    }
    .type-geospatial {
        background-color: #e3f2fd;
        color: #0d6efd;
    }
    .type-anomaly {
        background-color: #feebef;
        color: #d9534f;
    }
    .type-custom {
        background-color: #f5f5f5;
        color: #6c757d;
    }
    .template-stats {
        font-size: 0.9rem;
        color: #6c757d;
        margin-bottom: 15px;
    }
    .template-badge {
        font-size: 0.75rem;
    }
    .template-actions {
        display: flex;
        gap: 5px;
    }
    .template-icon {
        font-size: 2rem;
        margin-bottom: 10px;
        color: #3498db;
    }
    .empty-state {
        text-align: center;
        padding: 50px;
        background-color: #f9f9f9;
        border-radius: 10px;
        margin: 30px 0;
    }
    .empty-icon {
        font-size: 4rem;
        color: #d1d1d1;
        margin-bottom: 20px;
    }
    .filter-bar {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Report Templates</h1>
        <div>
            <a href="{{ url_for('reports.reports_dashboard') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Back to Dashboard
            </a>
            <a href="{{ url_for('reports.create_template') }}" class="btn btn-primary">
                <i class="fas fa-plus"></i> New Template
            </a>
        </div>
    </div>

    <!-- Filter Bar -->
    <div class="filter-bar">
        <div class="row g-2">
            <div class="col-md-4">
                <select class="form-select" id="type-filter">
                    <option value="all">All Template Types</option>
                    <option value="property_assessment">Property Assessment</option>
                    <option value="geospatial_analysis">Geospatial Analysis</option>
                    <option value="anomaly_report">Anomaly Report</option>
                    <option value="custom">Custom</option>
                </select>
            </div>
            <div class="col-md-6">
                <input type="text" class="form-control" id="search-filter" placeholder="Search templates...">
            </div>
            <div class="col-md-2">
                <select class="form-select" id="sort-filter">
                    <option value="name_asc">Name (A-Z)</option>
                    <option value="name_desc">Name (Z-A)</option>
                    <option value="date_desc">Newest First</option>
                    <option value="date_asc">Oldest First</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Templates Grid -->
    {% if templates %}
    <div class="row" id="templates-container">
        {% for template in templates %}
        <div class="col-md-4 template-item" data-type="{{ template.template_type }}">
            <div class="card template-card">
                <div class="card-header d-flex justify-content-between align-items-start">
                    <h5 class="card-title mb-0">{{ template.name }}</h5>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-light" type="button" id="dropdownMenuButton{{ loop.index }}" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownMenuButton{{ loop.index }}">
                            <li>
                                <a class="dropdown-item" href="{{ url_for('reports.view_template', template_id=template.template_id) }}">
                                    <i class="fas fa-eye fa-fw"></i> View Details
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="{{ url_for('reports.edit_template', template_id=template.template_id) }}">
                                    <i class="fas fa-edit fa-fw"></i> Edit Template
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="{{ url_for('reports.generate_report') }}?template_id={{ template.template_id }}">
                                    <i class="fas fa-file-export fa-fw"></i> Generate Report
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <a class="dropdown-item text-primary clone-template" href="#" data-template-id="{{ template.template_id }}" data-template-name="{{ template.name }}">
                                    <i class="fas fa-copy fa-fw"></i> Clone Template
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item text-danger delete-template" href="#" data-template-id="{{ template.template_id }}" data-template-name="{{ template.name }}">
                                    <i class="fas fa-trash fa-fw"></i> Delete Template
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        {% if template.template_type == 'property_assessment' %}
                        <i class="fas fa-home template-icon"></i>
                        <div class="template-type type-property">Property Assessment</div>
                        {% elif template.template_type == 'geospatial_analysis' %}
                        <i class="fas fa-map template-icon"></i>
                        <div class="template-type type-geospatial">Geospatial Analysis</div>
                        {% elif template.template_type == 'anomaly_report' %}
                        <i class="fas fa-exclamation-triangle template-icon"></i>
                        <div class="template-type type-anomaly">Anomaly Report</div>
                        {% else %}
                        <i class="fas fa-file-alt template-icon"></i>
                        <div class="template-type type-custom">Custom</div>
                        {% endif %}
                    </div>
                    
                    <p class="card-text">{{ template.description or "No description provided." }}</p>
                    
                    <div class="template-stats">
                        <div><i class="fas fa-layer-group fa-fw"></i> {{ template.section_count }} sections</div>
                        <div><i class="fas fa-clock fa-fw"></i> Last modified: {{ template.modified_at.split('T')[0] if template.modified_at else 'N/A' }}</div>
                    </div>
                    
                    <div class="mt-3">
                        <span class="badge bg-light text-dark template-badge">Version {{ template.version or '1.0' }}</span>
                        {% if template.metadata and template.metadata.tags %}
                            {% for tag in template.metadata.tags %}
                            <span class="badge bg-secondary template-badge">{{ tag }}</span>
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>
                <div class="card-footer">
                    <div class="template-actions">
                        <a href="{{ url_for('reports.view_template', template_id=template.template_id) }}" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-eye"></i> View
                        </a>
                        <a href="{{ url_for('reports.edit_template', template_id=template.template_id) }}" class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-edit"></i> Edit
                        </a>
                        <a href="{{ url_for('reports.generate_report') }}?template_id={{ template.template_id }}" class="btn btn-sm btn-success">
                            <i class="fas fa-file-export"></i> Generate
                        </a>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
        <div class="empty-icon">
            <i class="fas fa-file-alt"></i>
        </div>
        <h4>No Templates Found</h4>
        <p class="text-muted">Create your first report template to get started</p>
        <a href="{{ url_for('reports.create_template') }}" class="btn btn-primary mt-3">
            <i class="fas fa-plus"></i> Create New Template
        </a>
    </div>
    {% endif %}
</div>

<!-- Clone Template Modal -->
<div class="modal fade" id="cloneTemplateModal" tabindex="-1" aria-labelledby="cloneTemplateModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cloneTemplateModalLabel">Clone Template</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="clone-form" method="post">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="new-template-name" class="form-label">New Template Name</label>
                        <input type="text" class="form-control" id="new-template-name" name="new_name" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Clone Template</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Template Modal -->
<div class="modal fade" id="deleteTemplateModal" tabindex="-1" aria-labelledby="deleteTemplateModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteTemplateModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the template "<span id="delete-template-name"></span>"?</p>
                <p class="text-danger">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="delete-form" method="post">
                    <button type="submit" class="btn btn-danger">Delete Template</button>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Template filtering
        const typeFilter = document.getElementById('type-filter');
        const searchFilter = document.getElementById('search-filter');
        const sortFilter = document.getElementById('sort-filter');
        const templateContainer = document.getElementById('templates-container');
        
        function filterTemplates() {
            const typeValue = typeFilter.value;
            const searchValue = searchFilter.value.toLowerCase();
            const templates = document.querySelectorAll('.template-item');
            
            templates.forEach(template => {
                const templateType = template.getAttribute('data-type');
                const templateName = template.querySelector('.card-title').textContent.toLowerCase();
                const templateDesc = template.querySelector('.card-text').textContent.toLowerCase();
                
                // Check type filter
                const typeMatch = typeValue === 'all' || templateType === typeValue;
                
                // Check search filter
                const searchMatch = templateName.includes(searchValue) || 
                                 templateDesc.includes(searchValue);
                
                // Show/hide template
                if (typeMatch && searchMatch) {
                    template.style.display = '';
                } else {
                    template.style.display = 'none';
                }
            });
            
            checkEmptyState();
        }
        
        function sortTemplates() {
            const sortValue = sortFilter.value;
            const templates = Array.from(document.querySelectorAll('.template-item'));
            
            templates.sort((a, b) => {
                const nameA = a.querySelector('.card-title').textContent;
                const nameB = b.querySelector('.card-title').textContent;
                const dateA = a.querySelector('.template-stats .fa-clock').parentElement.textContent;
                const dateB = b.querySelector('.template-stats .fa-clock').parentElement.textContent;
                
                if (sortValue === 'name_asc') {
                    return nameA.localeCompare(nameB);
                } else if (sortValue === 'name_desc') {
                    return nameB.localeCompare(nameA);
                } else if (sortValue === 'date_desc') {
                    return dateB.localeCompare(dateA);
                } else if (sortValue === 'date_asc') {
                    return dateA.localeCompare(dateB);
                }
                
                return 0;
            });
            
            // Re-append templates in sorted order
            templates.forEach(template => {
                templateContainer.appendChild(template);
            });
        }
        
        function checkEmptyState() {
            const visibleTemplates = document.querySelectorAll('.template-item[style=""]').length;
            
            if (visibleTemplates === 0) {
                // If no templates are visible, show empty state
                let emptyState = document.querySelector('.empty-state');
                
                if (!emptyState) {
                    emptyState = document.createElement('div');
                    emptyState.className = 'empty-state';
                    emptyState.innerHTML = `
                        <div class="empty-icon">
                            <i class="fas fa-search"></i>
                        </div>
                        <h4>No Matching Templates</h4>
                        <p class="text-muted">Try adjusting your filters</p>
                        <button class="btn btn-outline-secondary mt-3" id="reset-filters">
                            <i class="fas fa-undo"></i> Reset Filters
                        </button>
                    `;
                    
                    // Insert after the templates container
                    templateContainer.insertAdjacentElement('afterend', emptyState);
                    
                    // Add event listener to reset button
                    document.getElementById('reset-filters').addEventListener('click', resetFilters);
                }
            } else {
                // If templates are visible, remove empty state if it exists
                const emptyState = document.querySelector('.empty-state');
                if (emptyState) {
                    emptyState.remove();
                }
            }
        }
        
        function resetFilters() {
            typeFilter.value = 'all';
            searchFilter.value = '';
            sortFilter.value = 'name_asc';
            filterTemplates();
            sortTemplates();
        }
        
        // Add event listeners
        typeFilter.addEventListener('change', () => {
            filterTemplates();
            sortTemplates();
        });
        
        searchFilter.addEventListener('input', () => {
            filterTemplates();
            sortTemplates();
        });
        
        sortFilter.addEventListener('change', () => {
            sortTemplates();
        });
        
        // Clone template buttons
        const cloneButtons = document.querySelectorAll('.clone-template');
        cloneButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                
                const templateId = this.getAttribute('data-template-id');
                const templateName = this.getAttribute('data-template-name');
                
                // Set form action
                document.getElementById('clone-form').action = `/reports/templates/${templateId}/clone`;
                
                // Set default name
                document.getElementById('new-template-name').value = `Copy of ${templateName}`;
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('cloneTemplateModal'));
                modal.show();
            });
        });
        
        // Delete template buttons
        const deleteButtons = document.querySelectorAll('.delete-template');
        deleteButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                
                const templateId = this.getAttribute('data-template-id');
                const templateName = this.getAttribute('data-template-name');
                
                // Set form action
                document.getElementById('delete-form').action = `/reports/templates/${templateId}/delete`;
                
                // Set template name in confirmation message
                document.getElementById('delete-template-name').textContent = templateName;
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('deleteTemplateModal'));
                modal.show();
            });
        });
    });
</script>
{% endblock %}