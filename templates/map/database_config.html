{% extends "layout.html" %}
{% from 'components/ui_components.html' import tf_card, tf_button, tf_alert, tf_input, tf_select %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col-12">
            <h1>Database Connections</h1>
            <p class="lead">Configure data sources for the property assessment system</p>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">PACS Database Connection</h5>
                </div>
                <div class="card-body">
                    <form method="post" action="{{ url_for('save_db_config') }}">
                        <input type="hidden" name="config_type" value="pacs">
                        
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="connection_name" class="form-label fw-semibold">Connection Name</label>
                                    <input type="text" class="form-control" id="connection_name" name="connection_name" value="PACS Database" required>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="connection_type" class="form-label fw-semibold">Connection Type</label>
                                    <select class="form-select" id="connection_type" name="connection_type" required>
                                        <option value="SQLAdvanced" selected>SQL Advanced</option>
                                        <option value="SQLStandard">SQL Standard</option>
                                        <option value="OracleAdvanced">Oracle Advanced</option>
                                        <option value="PostgreSQL">PostgreSQL</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="connection_path" class="form-label fw-semibold">Connection String</label>
                                    <input type="text" class="form-control" id="connection_path" name="connection_path" value="Data Source=JCHARRISPACS;Initial Catalog=pacs_oltp;Integrated Security=True">
                                    <div class="form-text">Database connection string for SQL Server</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="key_field" class="form-label fw-semibold">Key Field</label>
                                    <input type="text" class="form-control" id="key_field" name="key_field" value="Property_ID">
                                    <div class="form-text">Primary identifier field for properties</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Query Definitions Section -->
                        <h5 class="text-primary mb-3">Query Definitions</h5>
                        
                        <div class="card mb-4 border border-light">
                            <div class="card-header bg-light">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0">Property Query</h6>
                                    <button type="button" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-pencil-alt"></i> Edit
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="query_property_name" class="form-label fw-semibold">Name</label>
                                    <input type="text" class="form-control" id="query_property_name" name="query_property_name" value="Property">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="query_property_desc" class="form-label fw-semibold">Description</label>
                                    <input type="text" class="form-control" id="query_property_desc" name="query_property_desc" value="Property">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="query_property_sql" class="form-label fw-semibold">SQL Query</label>
                                    <textarea class="form-control font-monospace small" id="query_property_sql" name="query_property_sql" rows="5">SELECT t.prop_id as Property_ID, s.situs_display as Situs, t.[prop_val_yr], t.[sup_num], [update_dt], [school_id], [city_id], [state_cd], [class_cd], [land_type_cd], [yr_blt], [living_area], [imprv_unit_price], [imprv_add_val], [land_sqft], [land_acres], [land_front_feet], [land_depth], [land_lot], [land_unit_price], [region], [abs_subdv], [neighborhood], [subset], t.[map_id], t.[appraised_val], [land_num_lots], [land_appr_method], [land_total_sqft], [eff_yr_blt], [cond_cd], [accrued_depr_val], [constr_type_cd], [roof_type_cd], [foundation_cd], [ext_wall_cd], [quality_cd], [phys_depr], [funct_depr], [econ_depr], [disc_land], [disc_imprv], [homesite_val], [homesite_acres], [native_pasture_val], [native_pasture_acres], [imp_pasture_val], [imp_pasture_acres], [crop_val], [crop_acres], [orchard_val], [orchard_acres], [waste_val], [waste_acres], [timber_val], [timber_acres], [minerals_val], [min_inval_reason], [income_val], [market_val], [ag_use_val], [restricted_land_val], [prior_land_val], [prior_market_val]  FROM property_val t WITH (nolock) INNER JOIN situs s WITH (nolock) ON t.prop_id = s.prop_id and t.prop_val_yr = s.owner_tax_yr and t.sup_num = s.sup_num and t.prop_inactive_dt is null</textarea>
                                </div>
                                
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="query_property_immediate" name="query_property_immediate">
                                        <label class="form-check-label" for="query_property_immediate">
                                            Execute Immediately
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card mb-4 border border-light">
                            <div class="card-header bg-light">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0">Sales Query</h6>
                                    <button type="button" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-pencil-alt"></i> Edit
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="query_sales_name" class="form-label fw-semibold">Name</label>
                                    <input type="text" class="form-control" id="query_sales_name" name="query_sales_name" value="Sales">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="query_sales_desc" class="form-label fw-semibold">Description</label>
                                    <input type="text" class="form-control" id="query_sales_desc" name="query_sales_desc" value="Sales">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="query_sales_sql" class="form-label fw-semibold">SQL Query</label>
                                    <textarea class="form-control font-monospace small" id="query_sales_sql" name="query_sales_sql" rows="5">SELECT pv.prop_id as Property_ID, pv.hood_cd as 'NBHD', pp.state_cd, pp.class_cd, ac.file_as_name as Current_Owner, pv.legal_acreage, s.sl_type_cd, s.sl_ratio_type_cd, s.land_only_sale, pp.ls_table, CAST(s.sl_dt as datetime) as Sale_Date, s.sl_price, s.adjusted_sl_price, case when s.sl_price != 0 then CAST(ROUND((pv.market / s.sl_price), 2) as decimal (10,2)) else 0 end as Sales_Ratio, (pv.land_hstd_val + pv.land_non_hstd_val + pv.timber_market + pv.ag_market) as Land_Value, (pv.imprv_val) as Improvement_Value, pv.market as Market_Value FROM property_val pv WITH (nolock) INNER JOIN property_pro pp WITH ( nolock ) ON pv.prop_id = pp.prop_id AND pv.prop_val_yr = pp.owner_tax_yr AND pv.sup_num = pp.sup_num AND pv.prop_inactive_dt is null INNER JOIN owner o WITH (nolock) ON pv.prop_id = o.prop_id AND pv.prop_val_yr = o.owner_tax_yr AND pv.sup_num = o.sup_num AND primary_owner = 1 INNER JOIN account ac WITH (nolock) ON o.owner_id = ac.acct_id INNER JOIN sales s WITH (nolock) ON pv.prop_id = s.prop_id AND pv.prop_val_yr = s.sl_dt_yr AND pv.sup_num = s.sup_num WHERE s.sl_dt_yr >= 2020</textarea>
                                </div>
                                
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="query_sales_immediate" name="query_sales_immediate">
                                        <label class="form-check-label" for="query_sales_immediate">
                                            Execute Immediately
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Add Query Button -->
                        <div class="d-flex mb-4">
                            <button type="button" class="btn btn-outline-primary">
                                <i class="fas fa-plus"></i> Add New Query
                            </button>
                        </div>
                        
                        <!-- Connection Settings -->
                        <h5 class="text-primary mb-3">Connection Settings</h5>
                        
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="search_fetch_size" class="form-label fw-semibold">Search Fetch Size</label>
                                    <input type="number" class="form-control" id="search_fetch_size" name="search_fetch_size" value="500">
                                    <div class="form-text">Number of records to fetch in search results</div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="max_data_records" class="form-label fw-semibold">Max Data Records</label>
                                    <input type="number" class="form-control" id="max_data_records" name="max_data_records" value="10000">
                                    <div class="form-text">Maximum number of records to retrieve</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-end">
                            <button type="button" class="btn btn-secondary me-2">Test Connection</button>
                            <button type="submit" class="btn btn-primary">Save Configuration</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="tf-card insight">
                <div class="card-header">
                    <h5 class="card-title mb-0">Query Management</h5>
                </div>
                <div class="card-body">
                    <div class="text-center mb-4">
                        <i class="fas fa-database text-info" style="font-size: 32px;"></i>
                        <h6 class="mt-3">Manage Data Queries</h6>
                        <p class="text-muted small">Create, edit, and organize queries for accessing property data</p>
                    </div>
                    
                    <div class="list-group mb-3">
                        <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                            <span>
                                <i class="fas fa-table text-primary me-2"></i>
                                Property Data
                            </span>
                            <span class="badge bg-primary rounded-pill">Active</span>
                        </a>
                        <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                            <span>
                                <i class="fas fa-chart-line text-success me-2"></i>
                                Sales History
                            </span>
                            <span class="badge bg-primary rounded-pill">Active</span>
                        </a>
                        <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                            <span>
                                <i class="fas fa-home text-warning me-2"></i>
                                Land Details
                            </span>
                            <span class="badge bg-primary rounded-pill">Active</span>
                        </a>
                        <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                            <span>
                                <i class="fas fa-file-invoice-dollar text-danger me-2"></i>
                                Tax Information
                            </span>
                            <span class="badge bg-primary rounded-pill">Active</span>
                        </a>
                    </div>
                    
                    <a href="#" class="btn btn-outline-primary w-100">
                        <i class="fas fa-cog me-1"></i> Manage Query Templates
                    </a>
                </div>
            </div>
            
            <div class="tf-card flow mt-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Connection Settings</h5>
                </div>
                <div class="card-body">
                    <h6 class="mb-3 fw-semibold">Current Tax Year</h6>
                    <div class="form-group mb-4">
                        <select class="form-select" id="tax_year" name="tax_year">
                            <option value="2025" selected>2025</option>
                            <option value="2024">2024</option>
                            <option value="2023">2023</option>
                            <option value="2022">2022</option>
                            <option value="2021">2021</option>
                        </select>
                    </div>
                    
                    <h6 class="mb-3 fw-semibold">Connection Status</h6>
                    <div class="d-flex align-items-center mb-3">
                        <div class="d-flex align-items-center me-3">
                            <div class="bg-success rounded-circle me-2" style="width: 10px; height: 10px;"></div>
                            <span class="text-muted small">Connected</span>
                        </div>
                        <div class="text-muted small">Last updated: Today, 2:15 PM</div>
                    </div>
                    
                    <button class="btn btn-sm btn-outline-primary w-100">
                        <i class="fas fa-sync-alt me-1"></i> Refresh Connection
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Test connection button functionality
    document.querySelector('button.btn-secondary').addEventListener('click', function() {
        const connectionPath = document.getElementById('connection_path').value;
        const connectionName = document.getElementById('connection_name').value;
        
        // Show a testing message
        const button = this;
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
        button.disabled = true;
        
        // Simulate a connection test
        setTimeout(() => {
            // Reset button
            button.innerHTML = originalText;
            button.disabled = false;
            
            // Show success message
            const alertHtml = `
                <div class="alert alert-success alert-dismissible fade show mb-3" role="alert">
                    <i class="fas fa-check-circle me-2"></i> Successfully connected to database <strong>${connectionName}</strong>.
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            document.querySelector('.card-body form').insertAdjacentHTML('afterbegin', alertHtml);
        }, 1500);
    });
    
    // Form validation
    const form = document.querySelector('form');
    form.addEventListener('submit', function(event) {
        if (!form.checkValidity()) {
            event.preventDefault();
            event.stopPropagation();
        }
        form.classList.add('was-validated');
    });
});
</script>
{% endblock %}